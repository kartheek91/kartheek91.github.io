<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Painless Scripting Language-Series-1 | Learn By Doing</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Painless Scripting Language-Series-1" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Today we will learn about very intresting scripting language called Painless. So let’s jump directy into the topic." />
<meta property="og:description" content="Today we will learn about very intresting scripting language called Painless. So let’s jump directy into the topic." />
<link rel="canonical" href="http://localhost:4000/2021/02/07/painless-scripting-language-series-1.html" />
<meta property="og:url" content="http://localhost:4000/2021/02/07/painless-scripting-language-series-1.html" />
<meta property="og:site_name" content="Learn By Doing" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-07T13:15:20+05:30" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Painless Scripting Language-Series-1" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/02/07/painless-scripting-language-series-1.html"},"url":"http://localhost:4000/2021/02/07/painless-scripting-language-series-1.html","headline":"Painless Scripting Language-Series-1","dateModified":"2021-02-07T13:15:20+05:30","datePublished":"2021-02-07T13:15:20+05:30","description":"Today we will learn about very intresting scripting language called Painless. So let’s jump directy into the topic.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Learn By Doing" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Learn By Doing</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Painless Scripting Language-Series-1</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-02-07T13:15:20+05:30" itemprop="datePublished">Feb 7, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Today we will learn about very intresting scripting language called <strong>Painless</strong>. So let’s jump directy into the topic.</p>

<p><strong><em>Painless:</em></strong>
It is a simple, secure scripting language designed specifically for use with Elasticsearch. It is the default scripting language for Elasticsearch and can safely be used for inline and stored scripts.In fact, most Painless scripts are also valid Groovy, and simple Groovy scripts are typically valid Painless.</p>

<p>Painless scripts are parsed and compiled using the ANTLR4 and ASM libraries. Painless scripts are compiled directly into Java byte code and executed against a standard Java Virtual Machine.
You can use Painless anywhere scripts are used in Elasticsearch. Painless provides:</p>
<ul>
  <li>It is fast performance.</li>
  <li>Safety: Fine-grained allowlist with method call/field granularity.</li>
  <li>Optional typing: Variables and parameters can use explicit types or the dynamic def type.</li>
  <li>Syntax: Extends a subset of Java’s syntax to provide additional scripting language features.</li>
  <li>Optimizations: Designed specifically for Elasticsearch scripting.</li>
</ul>

<p><strong><em>Painless Evolution:</em></strong>
Since the earlier versions of ES, it supported scripting, but the scripting language has evolved over the ES releases. Starting with MVEL prior version 1.4, Groovy (post version 1.4), and now the latest entry <strong><em>Painless</em></strong>  starting ES 5.0, the scripting in ES has evolved. A key reason for this evolution is for the above mentioned features.</p>

<p>Prior the release of <strong><em>Painless</em></strong> in ES 5.0, the majority of the security vulnerabilities that were reported in ES had to deal with vulnerabilities due to the scripting. Painless scripting language addresses these issues and is more secure, and faster than its predecessors. Starting ES 5.0, “Painless” is the default scripting language and its syntax is similar to <strong>Groovy</strong>.</p>

<p>This blog takes it a level further and explains the various usages of scripting that would be very handy.</p>

<p>Before we can start using the scripts lets understand the syntax of scripts in ES.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"script": {
 "lang": "...", 
 "inline" | "stored": "...",
 "params": { ... }
 }
</code></pre></div></div>
<p>As shown above, the script syntax consists of three parts:</p>
<ol>
  <li>The language the script is written in, which defaults to painless.</li>
  <li>The script itself which may be specified as source for an inline script or id for a stored script.</li>
  <li>Any named parameters that should be passed into the script.</li>
</ol>

<p>Let’s illustrate how Painless works by loading some student stats into an Elasticsearch index:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT student/_bulk?refresh
{"index":{"_id":1}}
{"first_name":"kiran","last_name":"sangita","score":[9,27,1],"dob":"1980/08/13"}
{"index":{"_id":2}}
{"first_name":"kartheek","last_name":"gummaluri","score":[19,37,12],"dob":"1991/12/28"}
{"index":{"_id":3}}
{"first_name":"pavan","last_name":"arya","score":[22,12,34],"dob":"1989/01/22"}
{"index":{"_id":4}}
{"first_name":"murali","last_name":"sangita","score":[10,2,44],"dob":"1990/04/15"}
{"index":{"_id":5}}
{"first_name":"prudwi","last_name":"seeramreddi","score":[12,22,14],"dob":"1991/08/17"}
</code></pre></div></div>
<p><strong><em>Accessing Doc Values from Painless:</em></strong>
Document values can be accessed from a Map named doc.</p>

<p>For example, the following script calculates a student’s total score who name start’s with letter <strong>K</strong>. This example uses a strongly typed int and a for loop.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET student/_search
{
  "query": {
    "prefix": {
      "first_name": {
        "value": "k"
      }
    }
  },
  "script_fields": {
    "total_score": {
      "script": {
        "lang": "painless",
        "source": """
          int total = 0;
          for (int i = 0; i &lt; doc['score'].length; ++i) {
            total += doc['score'][i];
          
          }
          return total;
        """
      }
    }
  }
}
</code></pre></div></div>
<p><strong><em>Result</em></strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> "hits" : [
      {
        "_index" : "student",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 1.0,
        "fields" : {
          "total_score" : [
            37
          ]
        }
      },
      {
        "_index" : "student",
        "_type" : "_doc",
        "_id" : "2",
        "_score" : 1.0,
        "fields" : {
          "total_score" : [
            68
          ]
        }
      }
    ]
</code></pre></div></div>
<p>The following example uses a Painless script to sort the students by their combined first and last names. The names are accessed using doc[‘first_name’].keyword.value and doc[‘last_name’].keyword.value.
<strong><em>Query</em></strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET student/_search
{
  "query": {
    "match_all": {}
  },
  "sort": {
    "_script": {
      "type": "string",
      "order": "asc",
      "script": {
        "lang": "painless",
        "source": "doc['first_name.keyword'].value + ' ' + doc['last_name.keyword'].value"
      }
    }
  }
}
</code></pre></div></div>
<p><strong><em>Result</em></strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  "hits" : [
      {
        "_index" : "student",
        "_type" : "_doc",
        "_id" : "2",
        "_score" : null,
        "_source" : {
          "first_name" : "kartheek",
          "last_name" : "gummaluri",
          "score" : [
            19,
            37,
            12
          ],
          "dob" : "1991/12/28"
        },
        "sort" : [
          "kartheek gummaluri"
        ]
      },
      {
        "_index" : "student",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : null,
        "_source" : {
          "first_name" : "kiran",
          "last_name" : "sangita",
          "score" : [
            9,
            27,
            1
          ],
          "dob" : "1980/08/13"
        },
        "sort" : [
          "kiran sangita"
        ]
      },....]
</code></pre></div></div>
<p><strong><em>Missing Values</em></strong></p>

<p>Now let learn how to query if we have missing values either in last_name, first_name.doc[‘field’].value throws an exception if the field is missing in a document.</p>

<p>To check if a document is missing a value, you can call doc[‘field’].size() == 0. So let’s add another document in the <strong>student</strong> index.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT student/_doc/6
{"first_name":"bala","score":[11,33,12],"dob":"1971/04/21"}
</code></pre></div></div>
<p>If you observe in the above mentioned document we haven’t specified <strong>last_name</strong> and now let’s re-run the above mentioned query which concatenates first_name and last_name.</p>

<p>After executing the above mentioned query we end up with run time error.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
        "shard": 0,
        "index": "student",
        "node": "993H1-V5Qk6Qc2nOoZ0iuw",
        "reason": {
          "type": "script_exception",
          "reason": "runtime error",
          "script_stack": [
            "org.elasticsearch.index.fielddata.ScriptDocValues$Strings.get(ScriptDocValues.java:496)",
            "org.elasticsearch.index.fielddata.ScriptDocValues$Strings.getValue(ScriptDocValues.java:503)",
            "doc['first_name.keyword'].value + ' ' + doc['last_name.keyword'].value",
            "                                                                ^---- HERE"
          ],
          "script": "doc['first_name.keyword'].value + ' ' + doc['last_name.keyword'].value",
          "lang": "painless",
          "caused_by": {
            "type": "illegal_state_exception",
            "reason": "A document doesn't have a value for a field! Use doc[&lt;field&gt;].size()==0 to check if a document is missing a field!"
          }
        }
      }
</code></pre></div></div>
<p>If you observe the reason session it clearly saying that we are trying to access document which doesn’t have a value for a field. It is also providing recommendation for us.Now let’s re-write the query.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
GET student/_search
{
  "query": {
   "match_all": {}
  },
 "script_fields": {
   "full_name": {
     "script": {
       "lang": "painless",
        "source": """if(doc['last_name.keyword'].size()&gt;0 &amp;&amp; doc['first_name.keyword'].size()&gt;0) {  return doc['first_name.keyword'].value + ' ' + doc['last_name.keyword'].value}"""
       
     }
   }
 }
}
</code></pre></div></div>
<p>This way we can overcome the above mentioned exception.Finally I will conclude with an important information and we can learn in depth in upcoming blogs.</p>

<p>The first time Elasticsearch sees a new script, it compiles it and stores the compiled version in a cache. Compilation can be a heavy process.</p>

<p>If you need to pass variables into the script, you should pass them in as named params instead of hard-coding values into the script itself. We will try to learn these topic in upcoming blog post with an real time example.</p>

<p>Thanks,<br />
<strong><em>Kartheek Gummaluri</em></strong></p>

  </div><a class="u-url" href="/2021/02/07/painless-scripting-language-series-1.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Learn By Doing</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Learn By Doing</li><li><a class="u-email" href="mailto:kartheek.gummaluri@gmail.com">kartheek.gummaluri@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/kartheek91"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">kartheek91</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>This site is created to share my learnings.Please let me know if you have any doubts regarding my postings.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
